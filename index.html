<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Bad VÃ¶slau â†” Wien Hbf Train Departures</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body {
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      .card {
        border: 0;
      }

      .table td,
      .table th {
        vertical-align: middle;
      }

      .nav-tabs .nav-link {
        font-weight: 500;
      }

      .badge.text-bg-success,
      .badge.text-bg-danger,
      .badge.text-bg-secondary {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <header class="mb-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div>
            <h1 class="h3 mb-1">ðŸš‚ Bad VÃ¶slau â†” Wien Hauptbahnhof</h1>
            <p class="text-secondary mb-0">Live Train Departures</p>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button id="refreshBtn" class="btn btn-primary">
              ðŸ”„ Refresh Now
            </button>
            <button id="toggleAutoRefresh" class="btn btn-outline-secondary">
              Auto-refresh: On
            </button>
          </div>
        </div>
      </header>

      <section class="mb-3">
        <div class="row g-3">
          <div class="col-lg-8">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                  <div>
                    <p class="mb-1 text-secondary">Data status</p>
                    <p class="mb-0">
                      <span id="statusBadge" class="badge text-bg-secondary">
                        Waiting for data
                      </span>
                    </p>
                  </div>
                  <div class="text-end">
                    <p class="mb-1 text-secondary">Last updated</p>
                    <p id="lastUpdated" class="mb-0 fw-semibold">â€”</p>
                  </div>
                </div>
                <div class="mt-3 small text-secondary">
                  Showing trains in both directions between Bad VÃ¶slau and Wien
                  Hauptbahnhof. Data refreshes automatically every minute unless
                  paused.
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <p class="text-secondary mb-2">Quick stats</p>
                <div class="d-flex align-items-center justify-content-between">
                  <span class="fw-semibold">Bad VÃ¶slau â†’ Wien</span>
                  <span id="countBadToWien" class="badge text-bg-primary">0</span>
                </div>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <span class="fw-semibold">Wien â†’ Bad VÃ¶slau</span>
                  <span id="countWienToBad" class="badge text-bg-primary">0</span>
                </div>
                <div class="mt-3 text-secondary small">
                  <span id="stationInfo">Stations: â€”</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card shadow-sm">
        <div class="card-body">
          <ul class="nav nav-tabs" id="directionTabs" role="tablist"></ul>
          <div class="tab-content pt-3" id="directionTabContent"></div>
        </div>
      </section>

      <section class="mt-4">
        <div class="alert alert-info small mb-0">
          <strong>Data source:</strong> The Ã–BB HAFAS API via the bundled fetcher
          script. To update data, run <code>node fetch_departures.js</code> in the
          project directory.
        </div>
      </section>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const REFRESH_INTERVAL_MS = 60000;
      const DATA_PATH = "departures.json";

      const statusBadge = document.getElementById("statusBadge");
      const lastUpdated = document.getElementById("lastUpdated");
      const countBadToWien = document.getElementById("countBadToWien");
      const countWienToBad = document.getElementById("countWienToBad");
      const stationInfo = document.getElementById("stationInfo");
      const refreshBtn = document.getElementById("refreshBtn");
      const toggleAutoRefresh = document.getElementById("toggleAutoRefresh");
      const tabsContainer = document.getElementById("directionTabs");
      const tabContent = document.getElementById("directionTabContent");

      let autoRefreshEnabled = true;
      let refreshTimer = null;

      const formatDelay = (scheduled, actual) => {
        if (!scheduled || !actual || scheduled === actual) {
          return "â€”";
        }

        const [schedHour, schedMinute] = scheduled.split(":").map(Number);
        const [actualHour, actualMinute] = actual.split(":").map(Number);

        if (Number.isNaN(schedHour) || Number.isNaN(actualHour)) {
          return "â€”";
        }

        const scheduledMinutes = schedHour * 60 + schedMinute;
        const actualMinutes = actualHour * 60 + actualMinute;
        const delay = actualMinutes - scheduledMinutes;

        return delay > 0 ? `${delay}` : "â€”";
      };

      const formatLastUpdated = (isoString) => {
        if (!isoString) {
          return "â€”";
        }

        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) {
          return "â€”";
        }

        return new Intl.DateTimeFormat("de-AT", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          timeZone: "Europe/Vienna",
        }).format(date);
      };

      const buildTable = (trains) => {
        if (!trains || trains.length === 0) {
          return `<div class="alert alert-warning mb-0">No departures found.</div>`;
        }

        const rows = trains
          .map((train) => {
            if (!train) {
              return "";
            }

            const scheduled = train.ti || "N/A";
            const actual = train.rt?.dlt ?? scheduled;
            const delay = formatDelay(scheduled, actual);
            const actualDisplay =
              actual !== scheduled
                ? actual
                : '<span class="text-success">âœ“ On time</span>';

            return `
              <tr>
                <td>${scheduled}</td>
                <td>${actualDisplay}</td>
                <td>${delay}</td>
                <td>${train.pr ?? "Unknown"}</td>
                <td>${train.tr ?? "TBA"}</td>
              </tr>
            `;
          })
          .join("");

        return `
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col">Scheduled</th>
                  <th scope="col">Actual/Status</th>
                  <th scope="col">Delay (min)</th>
                  <th scope="col">Train</th>
                  <th scope="col">Platform</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;
      };

      const buildTabs = ({ badVoeslauToWien, wienToBadVoeslau }, isAfternoon) => {
        tabsContainer.innerHTML = "";
        tabContent.innerHTML = "";

        const tabs = isAfternoon
          ? [
              {
                id: "wien-to-bad",
                label: "ðŸš‚ Wien Hbf â†’ Bad VÃ¶slau",
                trains: wienToBadVoeslau,
              },
              {
                id: "bad-to-wien",
                label: "ðŸš‚ Bad VÃ¶slau â†’ Wien Hbf",
                trains: badVoeslauToWien,
              },
            ]
          : [
              {
                id: "bad-to-wien",
                label: "ðŸš‚ Bad VÃ¶slau â†’ Wien Hbf",
                trains: badVoeslauToWien,
              },
              {
                id: "wien-to-bad",
                label: "ðŸš‚ Wien Hbf â†’ Bad VÃ¶slau",
                trains: wienToBadVoeslau,
              },
            ];

        tabs.forEach((tab, index) => {
          const isActive = index === 0;
          const tabId = `${tab.id}-tab`;
          const contentId = `${tab.id}-content`;

          const tabButton = document.createElement("li");
          tabButton.className = "nav-item";
          tabButton.innerHTML = `
            <button
              class="nav-link ${isActive ? "active" : ""}"
              id="${tabId}"
              data-bs-toggle="tab"
              data-bs-target="#${contentId}"
              type="button"
              role="tab"
              aria-controls="${contentId}"
              aria-selected="${isActive}"
            >
              ${tab.label}
            </button>
          `;
          tabsContainer.appendChild(tabButton);

          const tabPane = document.createElement("div");
          tabPane.className = `tab-pane fade ${isActive ? "show active" : ""}`;
          tabPane.id = contentId;
          tabPane.role = "tabpanel";
          tabPane.innerHTML = `
            <h2 class="h5 mb-3">${tab.label}</h2>
            ${buildTable(tab.trains)}
          `;
          tabContent.appendChild(tabPane);
        });
      };

      const updateStatus = (state, message) => {
        statusBadge.className = `badge ${state}`;
        statusBadge.textContent = message;
      };

      const loadDepartures = async () => {
        updateStatus("text-bg-secondary", "Loading data...");

        try {
          const response = await fetch(`${DATA_PATH}?t=${Date.now()}`);
          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }

          const data = await response.json();

          const badVoeslauToWien = data.badVoeslauToWien || [];
          const wienToBadVoeslau = data.wienToBadVoeslau || [];

          const now = new Date();
          const isAfternoon = now.getHours() >= 12;

          buildTabs({ badVoeslauToWien, wienToBadVoeslau }, isAfternoon);
          lastUpdated.textContent = formatLastUpdated(data.lastUpdated);
          countBadToWien.textContent = badVoeslauToWien.length;
          countWienToBad.textContent = wienToBadVoeslau.length;

          const badStation = data.stations?.badVoeslau?.name ?? "Bad VÃ¶slau";
          const wienStation = data.stations?.wienHbf?.name ?? "Wien Hbf";
          stationInfo.textContent = `Stations: ${badStation} Â· ${wienStation}`;

          updateStatus("text-bg-success", "Data loaded");
        } catch (error) {
          updateStatus("text-bg-danger", "Failed to load data");
          tabContent.innerHTML = `
            <div class="alert alert-danger">
              Unable to load departures. Make sure <code>departures.json</code> exists
              by running <code>node fetch_departures.js</code>.
            </div>
          `;
        }
      };

      const startAutoRefresh = () => {
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }

        if (autoRefreshEnabled) {
          refreshTimer = setInterval(loadDepartures, REFRESH_INTERVAL_MS);
        }
      };

      refreshBtn.addEventListener("click", async () => {
        await loadDepartures();
      });

      toggleAutoRefresh.addEventListener("click", () => {
        autoRefreshEnabled = !autoRefreshEnabled;
        toggleAutoRefresh.textContent = `Auto-refresh: ${
          autoRefreshEnabled ? "On" : "Off"
        }`;
        startAutoRefresh();
      });

      loadDepartures();
      startAutoRefresh();
    </script>
  </body>
</html>
